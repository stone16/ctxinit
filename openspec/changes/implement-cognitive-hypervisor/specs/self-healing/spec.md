## ADDED Requirements

### Requirement: Context Hygiene Meta-Rule
The system SHALL embed a meta-rule in all compiled outputs to guide AI agents.

#### Scenario: Meta-rule content
- **WHEN** compiling any output file (CLAUDE.md, AGENTS.md, .mdc)
- **THEN** the following notice is included:
  ```markdown
  <!-- Context Hygiene -->
  This file is auto-generated from `.context/` source files.

  - **DO NOT** edit this file directly.
  - If you notice outdated rules compared to actual code, alert the user to update `.context/rules/`.
  - Source of Truth: `.context/` directory.
  - Regenerate: Run `ctx build` after editing source files.
  ```

#### Scenario: Meta-rule placement
- **WHEN** generating CLAUDE.md or AGENTS.md
- **THEN** the meta-rule is placed at the end of the file

#### Scenario: Meta-rule in MDC files
- **WHEN** generating .mdc files for Cursor
- **THEN** the meta-rule is placed as an HTML comment at the end

### Requirement: Build Checksum Embedding
The system SHALL embed a checksum in compiled outputs for integrity verification.

#### Scenario: Checksum generation
- **WHEN** compilation completes
- **THEN** a SHA-256 hash of the compiled content (excluding the checksum line itself) is calculated

#### Scenario: Checksum format
- **WHEN** embedding the checksum
- **THEN** it is formatted as an HTML comment:
  ```markdown
  <!-- ctx-checksum: sha256:abc123... -->
  ```

#### Scenario: Checksum placement
- **WHEN** the checksum is embedded
- **THEN** it is placed at the very end of the file after the meta-rule

### Requirement: Build Timestamp Embedding
The system SHALL embed a build timestamp in compiled outputs.

#### Scenario: Timestamp generation
- **WHEN** compilation completes
- **THEN** the current timestamp in ISO 8601 format is embedded

#### Scenario: Timestamp format
- **WHEN** embedding the timestamp
- **THEN** it is formatted as:
  ```markdown
  <!-- ctx-build-time: 2024-12-07T10:30:00Z -->
  ```

#### Scenario: Timestamp placement
- **WHEN** the timestamp is embedded
- **THEN** it is placed immediately before the checksum

### Requirement: Staleness Detection Hint
The system SHALL provide hints for AI agents to detect stale context.

#### Scenario: Age warning
- **WHEN** the meta-rule is generated
- **THEN** it includes guidance for agents to check if rules seem outdated

#### Scenario: Source reference
- **WHEN** the meta-rule is generated
- **THEN** it explicitly points to `.context/` as the source of truth

### Requirement: Regeneration Instructions
The system SHALL include regeneration instructions in compiled outputs.

#### Scenario: Build command reference
- **WHEN** the meta-rule is generated
- **THEN** it includes the command `ctx build` for regeneration

#### Scenario: Pre-commit note
- **WHEN** Git hooks are installed
- **THEN** the meta-rule notes that compilation happens automatically on commit

### Requirement: Do Not Edit Warning
The system SHALL prominently warn against direct editing of compiled files.

#### Scenario: Warning visibility
- **WHEN** generating compiled outputs
- **THEN** the "DO NOT edit this file directly" warning is prominent

#### Scenario: Alternative guidance
- **WHEN** warning against direct edits
- **THEN** the meta-rule directs users to edit `.context/rules/` instead

### Requirement: Integrity Verification Support
The system SHALL support verifying compiled file integrity.

#### Scenario: Verify command (optional)
- **WHEN** user runs `ctx verify` (if implemented)
- **THEN** the system recalculates checksums and compares with embedded values

#### Scenario: Mismatch detection
- **WHEN** a compiled file's content doesn't match its embedded checksum
- **THEN** the file has been modified outside of `ctx build`

#### Scenario: Agent verification hint
- **WHEN** AI agents read compiled files
- **THEN** they can optionally verify the checksum comment hasn't been tampered with

### Requirement: Version Compatibility Marker
The system SHALL embed version information for future compatibility.

#### Scenario: Version embedding
- **WHEN** compiling outputs
- **THEN** the ctxinit version used is embedded:
  ```markdown
  <!-- ctx-version: 1.0.0 -->
  ```

#### Scenario: Version placement
- **WHEN** the version is embedded
- **THEN** it is placed with other metadata (timestamp, checksum)

## Testing Requirements

### Unit Tests

#### Meta-Rule Tests
- [ ] Test meta-rule content includes all required guidance
- [ ] Test meta-rule placement at end of CLAUDE.md/AGENTS.md
- [ ] Test meta-rule as HTML comment in .mdc files
- [ ] Test "DO NOT edit" warning is prominent
- [ ] Test source of truth reference to .context/
- [ ] Test regeneration command reference

#### Checksum Tests
- [ ] Test SHA-256 hash calculation
- [ ] Test checksum excludes itself from calculation
- [ ] Test checksum format (sha256:prefix)
- [ ] Test checksum placement after meta-rule
- [ ] Test checksum consistency across builds

#### Timestamp Tests
- [ ] Test ISO 8601 format compliance
- [ ] Test timestamp placement before checksum
- [ ] Test timestamp updates on each build

#### Version Marker Tests
- [ ] Test version embedding format
- [ ] Test version placement with metadata
- [ ] Test version reflects actual ctxinit version

#### Integrity Verification Tests
- [ ] Test verify command recalculates checksum
- [ ] Test mismatch detection for modified files
- [ ] Test clean verification for unmodified files
- [ ] Test verification hint for AI agents

#### Staleness Detection Tests
- [ ] Test age warning guidance inclusion
- [ ] Test source reference in meta-rule
- [ ] Test pre-commit note when hooks installed

### Integration Tests

#### Full Self-Healing Pipeline Tests
- [ ] Test meta-rule + checksum + timestamp in build output
- [ ] Test all markers survive multiple rebuilds
- [ ] Test verification after manual file modification
- [ ] Test version compatibility across upgrades

#### AI Agent Interaction Tests
- [ ] Test meta-rule readability by AI agents
- [ ] Test checksum verification by AI agents
- [ ] Test staleness detection guidance effectiveness

### Consistency Tests

#### Cross-Output Consistency Tests
- [ ] Test consistent metadata format across CLAUDE.md, AGENTS.md
- [ ] Test consistent metadata format in .mdc files
- [ ] Test metadata ordering consistency
